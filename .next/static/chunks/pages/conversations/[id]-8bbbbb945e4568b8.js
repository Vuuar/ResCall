(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[132],{8219:function(e,s,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/conversations/[id]",function(){return t(4271)}])},1263:function(e,s,t){"use strict";t.d(s,{Z:function(){return d}});var n=t(1527),i=t(959),r=t(2852),a=t(3220),l=t(6507),o=t(8061),c=t.n(o);function d(e){let{professionalId:s,selectedId:t}=e,[o,d]=(0,i.useState)([]),[u,m]=(0,i.useState)(!0),[f,x]=(0,i.useState)(null);return((0,i.useEffect)(()=>{async function e(){try{m(!0);let{data:e,error:t}=await r.O.rpc("get_conversations_with_last_message",{p_professional_id:s});if(t)throw t;d(e)}catch(e){console.error("Error fetching conversations:",e),x("Failed to load conversations")}finally{m(!1)}}if(s){e();let t=r.O.channel("public:messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:"professional_id=eq.".concat(s)},()=>{e()}).subscribe();return()=>{r.O.removeChannel(t)}}},[s]),u)?(0,n.jsx)("div",{className:"p-4",children:(0,n.jsx)("div",{className:"animate-pulse space-y-4",children:[void 0,void 0,void 0,void 0,void 0].map((e,s)=>(0,n.jsx)("div",{className:"h-16 bg-gray-200 rounded"},s))})}):f?(0,n.jsx)("div",{className:"p-4 text-red-500",children:f}):0===o.length?(0,n.jsx)("div",{className:"p-4 text-center text-gray-500",children:"Aucune conversation"}):(0,n.jsx)("div",{className:"divide-y divide-gray-200",children:o.map(e=>(0,n.jsxs)(c(),{href:"/conversations/".concat(e.id),className:"block p-4 hover:bg-gray-50 ".concat(t===e.id?"bg-indigo-50":""),children:[(0,n.jsxs)("div",{className:"flex justify-between",children:[(0,n.jsxs)("div",{className:"font-medium",children:[e.client_name||e.client_phone,e.unread_count>0&&(0,n.jsx)("span",{className:"ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800",children:e.unread_count})]}),(0,n.jsx)("div",{className:"text-sm text-gray-500",children:(0,a.Z)(new Date(e.last_message_time),{addSuffix:!0,locale:l.Z})})]}),(0,n.jsx)("div",{className:"mt-1 text-sm text-gray-600 truncate",children:e.last_message}),(0,n.jsx)("div",{className:"mt-1 text-xs text-gray-500",children:"active"===e.status?(0,n.jsx)("span",{className:"text-green-500",children:"Active"}):(0,n.jsx)("span",{className:"text-gray-500",children:"Ferm\xe9e"})})]},e.id))})}},2607:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});var n=t(1527);t(959);var i=t(8391),r=t.n(i);function a(e){let{children:s,title:t="WhatsApp Booking"}=e;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(r(),{children:[(0,n.jsx)("title",{children:t}),(0,n.jsx)("meta",{name:"description",content:"WhatsApp Booking Platform"}),(0,n.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1"}),(0,n.jsx)("link",{rel:"icon",href:"/favicon.ico"})]}),(0,n.jsx)("div",{className:"min-h-screen flex flex-col",children:s})]})}},9230:function(e,s,t){"use strict";t.d(s,{a:function(){return r}});var n=t(959),i=t(2852);function r(){let[e,s]=(0,n.useState)(null),[t,r]=(0,n.useState)(!0);return(0,n.useEffect)(()=>{(async function(){try{r(!0);let{data:{session:e}}=await i.O.auth.getSession();if(null==e?void 0:e.user){let{data:t,error:n}=await i.O.from("professionals").select("*").eq("id",e.user.id).single();n?(console.error("Error fetching professional:",n),s(null)):s(t)}else s(null)}catch(e){console.error("Error getting user:",e),s(null)}finally{r(!1)}})();let{data:e}=i.O.auth.onAuthStateChange(async(e,t)=>{if("SIGNED_IN"===e&&(null==t?void 0:t.user)){let{data:e,error:n}=await i.O.from("professionals").select("*").eq("id",t.user.id).single();n?(console.error("Error fetching professional:",n),s(null)):s(e)}else"SIGNED_OUT"===e&&s(null)});return()=>{e.subscription.unsubscribe()}},[]),{user:e,loading:t}}},4271:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return x}});var n=t(1527),i=t(959),r=t(8896),a=t(9230),l=t(2607),o=t(1263),c=t(2852),d=t(6585),u=t(6507),m=t(8563);function f(e){let{conversationId:s,professionalId:t}=e,[r,a]=(0,i.useState)([]),[l,o]=(0,i.useState)(""),[f,x]=(0,i.useState)(!0),[h,g]=(0,i.useState)(!1),[p,v]=(0,i.useState)(null),[_,j]=(0,i.useState)(null),N=(0,i.useRef)(null);(0,i.useEffect)(()=>{async function e(){try{x(!0);let{data:e,error:t}=await c.O.from("conversations").select("*").eq("id",s).single();if(t)throw t;j(e);let{data:n,error:i}=await c.O.from("messages").select("*").eq("conversation_id",s).order("created_at",{ascending:!0});if(i)throw i;a(n),await c.O.from("messages").update({is_read:!0}).eq("conversation_id",s).eq("is_from_client",!0).eq("is_read",!1)}catch(e){console.error("Error fetching conversation data:",e),v("Failed to load conversation")}finally{x(!1)}}if(s){e();let t=c.O.channel("conversation:".concat(s)).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:"conversation_id=eq.".concat(s)},e=>{a(s=>[...s,e.new]),e.new.is_from_client&&c.O.from("messages").update({is_read:!0}).eq("id",e.new.id)}).subscribe();return()=>{c.O.removeChannel(t)}}},[s]),(0,i.useEffect)(()=>{var e;null===(e=N.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[r]);let y=async e=>{if(e.preventDefault(),l.trim())try{g(!0);let{data:e,error:n}=await c.O.from("professionals").select("phone_number").eq("id",t).single();if(n)throw n;let{data:i,error:r}=await c.O.from("messages").insert([{conversation_id:s,content:l,is_from_client:!1,message_type:"text"}]).select().single();if(r)throw r;let a=await fetch("/api/whatsapp/send",{method:"POST",headers:{"Content-Type":"application/json","x-user-id":t},body:JSON.stringify({to:_.client_phone,message:l,from:e.phone_number})});if(!a.ok){let e=await a.json();throw Error(e.error||"Failed to send message")}o("")}catch(e){console.error("Error sending message:",e),m.Am.error("Erreur lors de l'envoi du message")}finally{g(!1)}};return f?(0,n.jsx)("div",{className:"p-4",children:"Chargement de la conversation..."}):p?(0,n.jsx)("div",{className:"p-4 text-red-500",children:p}):(0,n.jsxs)("div",{className:"flex flex-col h-full",children:[(0,n.jsxs)("div",{className:"p-4 border-b",children:[(0,n.jsx)("h2",{className:"text-lg font-medium",children:_.client_name||_.client_phone}),(0,n.jsx)("p",{className:"text-sm text-gray-500",children:_.client_phone})]}),(0,n.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[r.map(e=>(0,n.jsx)("div",{className:"flex ".concat(e.is_from_client?"justify-start":"justify-end"),children:(0,n.jsxs)("div",{className:"max-w-xs sm:max-w-md rounded-lg px-4 py-2 ".concat(e.is_from_client?"bg-gray-100 text-gray-800":"bg-indigo-600 text-white"),children:["voice"===e.message_type&&e.voice_url?(0,n.jsxs)("div",{children:[(0,n.jsx)("audio",{controls:!0,src:e.voice_url,className:"w-full"}),(0,n.jsx)("p",{className:"mt-2",children:e.content})]}):(0,n.jsx)("p",{children:e.content}),(0,n.jsx)("p",{className:"text-xs mt-1 ".concat(e.is_from_client?"text-gray-500":"text-indigo-200"),children:(0,d.Z)(new Date(e.created_at),"HH:mm",{locale:u.Z})})]})},e.id)),(0,n.jsx)("div",{ref:N})]}),(0,n.jsx)("div",{className:"p-4 border-t",children:(0,n.jsxs)("form",{onSubmit:y,className:"flex",children:[(0,n.jsx)("input",{type:"text",value:l,onChange:e=>o(e.target.value),placeholder:"Tapez votre message...",className:"flex-1 rounded-l-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500",disabled:h}),(0,n.jsx)("button",{type:"submit",disabled:h||!l.trim(),className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-r-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50",children:h?"Envoi...":"Envoyer"})]})})]})}function x(){let e=(0,r.useRouter)(),{id:s}=e.query,{user:t,loading:i}=(0,a.a)();return i?(0,n.jsx)(l.Z,{children:(0,n.jsx)("div",{className:"p-8 text-center",children:"Chargement..."})}):t?(0,n.jsx)(l.Z,{children:(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 h-[calc(100vh-64px)]",children:[(0,n.jsxs)("div",{className:"md:col-span-1 lg:col-span-1 border-r overflow-y-auto",children:[(0,n.jsx)("div",{className:"p-4 border-b",children:(0,n.jsx)("h2",{className:"text-lg font-medium",children:"Conversations"})}),(0,n.jsx)(o.Z,{professionalId:t.id,selectedId:s})]}),(0,n.jsx)("div",{className:"md:col-span-2 lg:col-span-3 flex flex-col",children:s?(0,n.jsx)(f,{conversationId:s,professionalId:t.id}):(0,n.jsx)("div",{className:"flex-1 flex items-center justify-center text-gray-500",children:"S\xe9lectionnez une conversation pour afficher les messages"})})]})}):(0,n.jsx)(l.Z,{children:(0,n.jsx)("div",{className:"p-8 text-center",children:"Veuillez vous connecter pour acc\xe9der \xe0 cette page."})})}}},function(e){e.O(0,[61,585,698,774,888,179],function(){return e(e.s=8219)}),_N_E=e.O()}]);